function init(){esri.config.defaults.map.zoomDuration=500,esri.config.defaults.map.panDuration=600;var a=new esri.geometry.Extent({xmin:-21345286.56759694,ymin:-4757666.328089946,xmax:3701598.860882933,ymax:6709110.907135996,spatialReference:{wkid:102100}}),b=[{level:2,resolution:39135.7584820001,scale:147914381.897889},{level:3,resolution:19567.8792409999,scale:73957190.948944},{level:4,resolution:9783.93962049996,scale:36978595.474472},{level:5,resolution:4891.96981024998,scale:18489297.737236},{level:6,resolution:2445.98490512499,scale:9244648.868618}];map=new esri.Map("centerDiv_map",{extent:a,fitExtent:!0,lods:b,navigationMode:"classic",wrapAround180:!0}),dojo.connect(map,"onUpdateStart",function(){dojo.byId("loadingImage").style.display=""}),dojo.connect(map,"onUpdateEnd",function(){dojo.byId("loadingImage").style.display="none"}),dojo.connect(map,"onLoad",function(){dojo.connect(dijit.byId("centerDiv_map"),"resize",map,map.resize),showBaseMapGallery(),dojo.connect(map,"onMouseMove",showCoords),dojo.connect(map,"onExtentChange",onMapExtentChange),onMapExtentChange(),showCoords(map.extent.getCenter()),console.log("*** MAP Loaded ****"),dojo.byId("preloader_loading_image").style.display="none",dojo.byId("preloader_button").style.display="block",setTimeout(hideLoader,2e3)});var c="http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer";basemapLayer=new esri.layers.ArcGISTiledMapServiceLayer(c,{id:"basemapLayer"}),map.addLayer(basemapLayer),console.log("Amphibians : "+amphibians_list_data.length);var d={identifier:"ID",label:"common_name",items:amphibians_list_data};amphibiansStore=new dojo.data.ItemFileReadStore({data:d});var e={identifier:"ID",label:"scientific_name",items:dojo.clone(amphibians_list_data)};amphibiansStore_sc=new dojo.data.ItemFileReadStore({data:e}),console.log("Birds : "+birds_list_data.length);var d={identifier:"ID",label:"common_name",items:birds_list_data};birdsStore=new dojo.data.ItemFileReadStore({data:d});var e={identifier:"ID",label:"scientific_name",items:dojo.clone(birds_list_data)};birdsStore_sc=new dojo.data.ItemFileReadStore({data:e}),chooseOption("birds"),currentCategory="specific_species",console.log("Mammals : "+mammals_list_data.length),mammalsStore=new dojo.data.ItemFileReadStore({data:{identifier:"ID",label:"common_name",items:mammals_list_data}});var e={identifier:"ID",label:"scientific_name",items:dojo.clone(mammals_list_data)};mammalsStore_sc=new dojo.data.ItemFileReadStore({data:e}),birdsURL="http://maps.esri.com/apl12/rest/services/Lawler/BirdsNew/ImageServer",amphibiansURL="http://maps.esri.com/apl12/rest/services/Lawler/AmphibsNew/ImageServer",mammalsURL="http://maps.esri.com/apl12/rest/services/Lawler/MammalsNew/ImageServer",birdsQueryLayer=new esri.tasks.QueryTask(birdsURL),mammalsQueryLayer=new esri.tasks.QueryTask(mammalsURL),amphibiansQueryLayer=new esri.tasks.QueryTask(amphibiansURL);var f=new esri.layers.ImageServiceParameters;f.noData=0,f.format="png",f.interpolation="RSP_NearestNeighbor",grayLayer=new esri.layers.ArcGISDynamicMapServiceLayer("http://maps.esri.com/apl12/rest/services/Lawler/Lawler/MapServer",{id:"grayLayer",visible:!1,opacity:.6}),grayLayer.setVisibleLayers([3]),birdsLayer=new esri.layers.ArcGISImageServiceLayer(birdsURL,{id:"birdsLayer",visible:!1,opacity:.7,imageServiceParameters:f}),mammalsLayer=new esri.layers.ArcGISImageServiceLayer(mammalsURL,{id:"mammalsLayer",visible:!1,opacity:.7,imageServiceParameters:f}),amphibiansLayer=new esri.layers.ArcGISImageServiceLayer(amphibiansURL,{id:"amphibiansLayer",visible:!1,opacity:.7,imageServiceParameters:f}),extentGraphicsLayer=new esri.layers.GraphicsLayer({id:"testGraphics",displayOnPan:!0,visible:!0}),map.addLayers([grayLayer,birdsLayer,mammalsLayer,amphibiansLayer,extentGraphicsLayer]),afterInit()}function afterInit(){}function hideLoader(){dojo.fadeOut({node:"preloader",duration:700,onEnd:function(){dojo.style("preloader","display","none")}}).play()}function changeCategory(a){console.log("Inside change categorgy"),console.log("Got value: "+a.target.value),currentCategory=a.target.value,currentCategory=="specific_species"?hideSpeciesSelection(!1):(hideSpeciesSelection(!0),updateOptions())}function getCellValues(){if(gpBusy)return;hideChart(),dojo.byId("cmap_info").innerHTML="Click on the map to get values";var a=dojo.connect(map,"onClick",function(b){gpBusy=!0,dojo.byId("loadingImage").style.display="";var c=esri.geometry.webMercatorToGeographic(b.mapPoint);dojo.byId("cmap_info").innerHTML="Trying to find values for location "+c.y.toFixed(2)+" , "+c.x.toFixed(2),dojo.disconnect(a);var d=new esri.Graphic(c,null,{OBJECTID:11}),e=new esri.tasks.FeatureSet;e.features=[d];var f={mammals:"Mammal",birds:"Bird",amphibians:"Amphibian"},g=new esri.tasks.Geoprocessor("http://maps.esri.com/apl12/rest/services/Lawler/ReturnSpecies/GPServer/ReturnAListOfSpecies"),h={Input_Point:e,Scenario_Info:currentMosaicName,SpeciesType:species_type};console.log(h),g.execute(h,function(a){console.log("Got GP results back"),console.log(a);var b=a[0].value.features,d=a[1].value.features;if(b.length>0){var e;dojo.forEach(b,function(a){})}if(d.length>0){dojo.byId("cmap_info").innerHTML="Success! Summarizing "+b.length+" results";var f=0,g=0,h=0;dojo.forEach(d,function(a){a.attributes.Range==2&&(h=a.attributes.FREQUENCY),a.attributes.Range==3&&(g=a.attributes.FREQUENCY),a.attributes.Range==4&&(f=a.attributes.FREQUENCY)}),drawchart(c.y.toFixed(4),c.x.toFixed(4),h,g,f)}else clearTimeout(timeoutHandler),dojo.byId("cmap_info").innerHTML="Sorry! No results for this location.",timeoutHandler=setTimeout(hideChart,5e3);dojo.byId("loadingImage").style.display="none",gpBusy=!1},function(a){console.error(a),dojo.byId("cmap_info").innerHTML="Sorry! Unable to get values for this location.",dojo.byId("loadingImage").style.display="none",gpBusy=!1,timeoutHandler=setTimeout(hideChart,3e3)})})}function hideChart(){dojo.byId("chartdiv").style.display="none",dojo.byId("cmap_info").innerHTML="Choose one of the combinations OR Choose different fauna",clearTimeout(timeoutHandler)}function drawchart(a,b,c,d,e){var f=dojo.byId("chartdiv");f.style.display="";var g=new google.visualization.DataTable;g.addColumn("string","Range:"),g.addColumn("number","Total:"),g.addRows([["Contracting",c],["Expanding",d],["Stable",e]]);var h=new google.visualization.PieChart(dojo.byId("chartcont"));h.draw(g,{width:dojo.style("chartdiv","width"),height:dojo.style("chartdiv","height"),legend:{position:"bottom"},pieSliceText:"value",pieSliceTextStyle:{color:"#222222",fontSize:12},is3D:!0,colors:["#fe0000","#98e405","#257400"],title:"Range values for "+a+","+b})}function showCoords(a){var b=dojo.byId("coordsinfo");if(b===null||b===undefined){console.error("coords div not defined");return}var c=esri.geometry.webMercatorToGeographic(a.mapPoint||a);if(c===null||c===undefined)return;b.innerHTML="Lat: "+c.y.toFixed(2)+"&nbsp;&nbsp;Lon: "+c.x.toFixed(2)}function onMapExtentChange(){var a=Math.round(esri.geometry.getScale(map));a>999&&a<=999999?a=Math.round(a/1e3)+" K":a>999999?a=Math.round(a/1e6)+" M":a>0&&a<=999&&(a=Math.round(a)+" Ft"),dojo.byId("scaleinfo").innerHTML="Scale: 1 <b>:</b> "+a}function showBaseMapGallery(){var a=new esri.dijit.BasemapGallery({showArcGISBasemaps:!0,map:map},"basemapGallery");a.startup()}function changeTransparency(a){currentLayer.setOpacity(a.toFixed(2)),grayLayer.setOpacity(a.toFixed(2)),dojo.style("legend_image","opacity",a.toFixed(2))}function chooseOption(a){dojo.query(".selected").removeClass("selected");var b="#"+a+"_card";dojo.query(b).addClass("selected"),currentOption=a,a=="all"?(hideSpeciesSelection(!0),species_type="all",species_ID=null,dojo.byId("specific_species_container").style.display="none",dojo.byId("all_species_container").style.display="",updateOptions()):(dojo.byId("all_species_container").style.display="none",dojo.byId("specific_species_container").style.display="",hideSpeciesSelection(!1),dojo.byId("cmap_info").innerHTML="Choose one of the combinations OR Choose different fauna",selectSpeciesType(a),dojo.style("cmap_legend","display",""))}function hideSpeciesSelection(a){a?(dijit.byId("dd_species").attr("disabled",!0),dijit.byId("dd_species_sc").attr("disabled",!0),currentOption=="all"&&(dijit.byId("radioOne").attr("disabled",!0),dijit.byId("radioTwo").set("checked",!0))):(dijit.byId("dd_species").attr("disabled",!1),dijit.byId("dd_species_sc").attr("disabled",!1),currentOption!="all"&&dijit.byId("radioOne").attr("disabled",!1).set("checked",!0))}function resetUI(){dojo.byId("infobox")&&(dojo.byId("infobox").style.display="none"),currentLayer&&(currentLayer.hide(),grayLayer.hide(),extentGraphicsLayer.hide()),newMapExtent=null}function selectSpeciesType(a){if(species_type&&a==species_type)return;console.log("Species Type Selected : "+a),resetUI(),species_type=a;var b=dijit.byId("dd_species"),c=dijit.byId("dd_species_sc");species_type=="mammals"?(b.store=mammalsStore,c.store=mammalsStore_sc):species_type=="birds"?(b.store=birdsStore,c.store=birdsStore_sc):species_type=="amphibians"&&(b.store=amphibiansStore,c.store=amphibiansStore_sc),b.store&&b.store._jsonData&&b.store._jsonData.items.length>0?(b.set("value",b.store._jsonData.items[0].ID),c.set("value",c.store._jsonData.items[0].ID)):b.store&&b.store._arrayOfAllItems&&b.store._arrayOfAllItems.length>0?(b.set("value",b.store._arrayOfAllItems[0].ID[0]),c.set("value",c.store._arrayOfAllItems[0].ID[0])):console.log("***** Store not set ****")}function selectSpecies(a){if(a){if(species_ID&&a==species_ID){console.log("Duplicate request for "+a);return}console.log("Processing selection : "+a);var b=dijit.byId("dd_species"),c=dijit.byId("dd_species_sc");species_ID=a,updateOptions();var d=c.value==a?c:b;d.store.fetch({query:{ID:a},onComplete:function(a,b){a&&a.length>0&&updateInfoBox(a[0])}}),c.value!==b.value&&(c.value!=a&&(console.log("Resetting scientific name drop-down to "+a),c.set("value",a)),b.value!=a&&(console.log("Resetting common name drop-down to "+a),b.set("value",a)))}}function fixTimePeriod(){var a=dd_model.get("value")+dd_scenario.get("value"),b={};b.selected=!1,b.disabled=!1,a=="ukmo_hadcm3a2"||a=="ncar_ccsm3_0a2"||a=="ncar_ccsm3_0a1b"||a=="cnrm_cm3a2"?(console.log("inside 2071_2099 hack"),dd_timeperiod.options[2].value!="2071_2099"&&(b.value="2071_2099",b.label="2071 to 2099",dd_timeperiod.value=="2071_2100"&&(b.selected=!0),dd_timeperiod.addOption(b),dd_timeperiod.removeOption(2),console.log("Updated Current/Option2 timeperiod value: ",dd_timeperiod.value,dd_timeperiod.options[2].value))):dd_timeperiod.options[2].value!="2071_2100"&&(b.value="2071_2100",b.label="2071 to 2100",dd_timeperiod.value=="2071_2099"&&(b.selected=!0),dd_timeperiod.addOption(b),dd_timeperiod.removeOption(2),console.log("Updated Current/Option2 timeperiod value: ",dd_timeperiod.value,dd_timeperiod.options[2].value))}function changeLegend(a){a&&a.indexOf("ensemble")>-1?(dojo.byId("legend_image").src="images/ensemblelegend.png",dojo.byId("legend_image").style.width="188px"):(dojo.byId("legend_image").src="images/legend.png",dojo.byId("legend_image").style.width="203px")}function updateOptions(){fixTimePeriod();var a={type:"",species:"",model:"",scenario:"",category:"",timeperiod:""};species_type=="mammals"?a.type="M":species_type=="birds"?a.type="B":species_type=="amphibians"?a.type="A":species_type=="all"&&(a.type="all"),a.species=species_ID,a.model=dd_model.get("value"),a.scenario=dd_scenario.get("value"),a.timeperiod=dd_timeperiod.get("value"),a.category=currentCategory,updateLayer(a),changeLegend(a.model)}function updateInfoBox(a){var b=dojo.byId("infobox"),c=dojo.byId("infobox_content"),d="";species_type=="mammals"?d+="<span class='block'>Class : Mammals</span>":species_type=="amphibians"?d+="<span class='block'>Class : Amphibians</span>":species_type=="birds"&&(d+="<span class='block'>Class : Birds</span>"),d+="<span class='block'>Order : "+a.order_[0]+"</span>",d+="<span class='block'>Family : "+a.family[0]+"</span>",d+="<span class='block'>Scientific Name : "+a.scientific_name[0]+"</span>",d+="<span class='block'>Common Name : "+a.common_name[0]+"</span>",d+="<span class='block'>More Info : ",d+="<a target='_blank' title='Link opens in new window' href='http://en.wikipedia.org/wiki/"+a.scientific_name[0]+"'>Wikipedia</a></span>",c.innerHTML=d,b.style.display=""}function updateLayer(a){console.log(a),resetUI(),newMapExtent=null,currentLayer&&(currentLayer.hide(),currentLayer=null);if(a.category=="specific_species"&&a.type!="all"){grayLayer.show(),dojo.byId("infobox").style.display="";var b=a.type,c=a.species+"_"+a.model+"_"+a.scenario+"_"+a.timeperiod;console.log("Mosaic Query to send: "+c);var d='"NewName"=\''+c+"'";console.log("Where clause: "+d);var e=new esri.layers.MosaicRule;e.sortField="Name",e.method=esri.layers.MosaicRule.METHOD_ATTRIBUTE,e.where=d;var f=new esri.tasks.Query;f.returnGeometry=!0,f.outSpatialReference=map.spatialReference,f.outFields=["Name"],f.where=d,b=="B"?(birdsLayer.setMosaicRule(e),birdsLayer.show(),currentLayer=birdsLayer,birdsQueryLayer.execute(f,function(a){if(a.features.length>0&&a.features[0].geometry){console.log("Mosaic name: "+a.features[0].attributes.Name),currentMosaicName=a.features[0].attributes.Name;var b=a.features[0],c=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([39,96,151]),3));b.setSymbol(c),extentGraphicsLayer.add(b),newMapExtent=a.features[0].geometry.getExtent(),map.setExtent(newMapExtent.expand(1.1),!0);var d=dojo.connect(map,"onExtentChange",function(){dojo.disconnect(d),map.centerAt(newMapExtent.getCenter()),setTimeout(function(){extentGraphicsLayer.clear()},1e3)})}else console.log("Unable to get extent. Using default.")})):b=="M"?(mammalsLayer.setMosaicRule(e),mammalsLayer.show(),currentLayer=mammalsLayer,mammalsQueryLayer.execute(f,function(a){if(a.features.length>0&&a.features[0].geometry){console.log("Setting map extent to footprint extent"),console.log("Mosaic name: "+a.features[0].attributes.Name),currentMosaicName=a.features[0].attributes.Name;var b=a.features[0],c=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([39,96,151]),3));b.setSymbol(c),extentGraphicsLayer.add(b),newMapExtent=a.features[0].geometry.getExtent(),map.setExtent(newMapExtent.expand(1.1),!0);var d=dojo.connect(map,"onExtentChange",function(){console.log("Mammal: inside map extent change event"),dojo.disconnect(d),map.centerAt(newMapExtent.getCenter()),setTimeout(function(){extentGraphicsLayer.clear()},1e3)})}else console.log("Unable to get extent. Using default.")})):b=="A"&&(amphibiansLayer.setMosaicRule(e),amphibiansLayer.show(),currentLayer=amphibiansLayer,amphibiansQueryLayer.execute(f,function(a){if(a.features.length>0&&a.features[0].geometry){console.log("Setting map extent to footprint extent"),console.log("Mosaic name: "+a.features[0].attributes.Name),currentMosaicName=a.features[0].attributes.Name;var b=a.features[0],c=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([39,96,151]),3));b.setSymbol(c),extentGraphicsLayer.add(b),newMapExtent=a.features[0].geometry.getExtent(),map.setExtent(newMapExtent.expand(1.1),!0);var d=dojo.connect(map,"onExtentChange",function(){dojo.disconnect(d),map.centerAt(newMapExtent.getCenter()),setTimeout(function(){extentGraphicsLayer.clear()},1e3)})}else console.log("Unable to get extent. Using default.")}))}}function showAdvancedSearch(){var a=null;dijit.byId("advancedDialog")?a=dijit.byId("advancedDialog"):a=new dijit.Dialog({id:"advancedDialog",title:"Advanced Filter Tool",style:"width: 600px; height:400px; max-height:50%; overflow:auto;",content:""}),a.show()}"use strict";var map,basemapLayer,grayLayer,extentGraphicsLayer,birdsQueryLayer,mammalsQueryLayer,amphibiansQueryLayer,birdsLayer,mammalsLayer,amphibiansLayer,speciesTable,mammalsStore,amphibiansStore,birdsStore,mammalsStore_sc,amphibiansStore_sc,birdsStore_sc,currentLayer,species_type,species_ID,newMapExtent,currentMosaicName,currentCategory,currentOption,birdsURL,mammalsURL,amphibiansURL,gpBusy=!1,timeoutHandler;